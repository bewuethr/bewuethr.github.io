<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-CA" xml:lang="en-CA">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2020-02-23" />
  <title>Fonts and more</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #073642;
        color: #839496;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #839496;  padding-left: 4px; }
    div.sourceCode
      { color: #839496; background-color: #002b36; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #d33682; font-weight: bold; } /* Alert */
    code span.an { color: #dc322f; } /* Annotation */
    code span.at { color: #b58900; } /* Attribute */
    code span.bn { color: #2aa198; } /* BaseN */
    code span.bu { color: #859900; } /* BuiltIn */
    code span.cf { color: #859900; } /* ControlFlow */
    code span.ch { color: #dc322f; } /* Char */
    code span.cn { color: #2aa198; } /* Constant */
    code span.co { color: #586e75; font-style: italic; } /* Comment */
    code span.cv { color: #268bd2; } /* CommentVar */
    code span.do { color: #2aa198; } /* Documentation */
    code span.dt { color: #cb4b16; } /* DataType */
    code span.dv { color: #2aa198; } /* DecVal */
    code span.er { color: #ffffff; background-color: #ff0000; } /* Error */
    code span.ex { color: #839496; } /* Extension */
    code span.fl { color: #2aa198; } /* Float */
    code span.fu { color: #268bd2; } /* Function */
    code span.im { color: #2aa198; } /* Import */
    code span.in { color: #2aa198; } /* Information */
    code span.kw { color: #859900; } /* Keyword */
    code span.op { color: #859900; } /* Operator */
    code span.ot { color: #859900; } /* Other */
    code span.pp { color: #cb4b16; } /* Preprocessor */
    code span.re { color: #cb4b16; } /* RegionMarker */
    code span.sc { color: #dc322f; } /* SpecialChar */
    code span.ss { color: #268bd2; } /* SpecialString */
    code span.st { color: #2aa198; } /* String */
    code span.va { color: #cb4b16; } /* Variable */
    code span.vs { color: #2aa198; } /* VerbatimString */
    code span.wa { color: #dc322f; font-weight: bold; } /* Warning */
  </style>
  <link rel="stylesheet" href="/pbb.css" />
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,400i,700,700i|Source+Sans+Pro:400,400i,700,700i&display=swap" rel="stylesheet">
  <link rel="icon" href="/favicon.png" sizes="32x32" type="image/png">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div id="blogtitle"><a href="./">ArtifiShell Intelligence</a></div>
<header id="title-block-header">
<h1 class="title">Fonts and more</h1>
<p class="date">2020-02-23</p>
</header>
<p>Pandoc Bash Blog has experienced a few upgrades since the <a
href="https://bewuethr.github.io/2020-02-16-css-for-pbb.html">addition
of CSS</a>. Some are conveniences when using <code>pbb</code> on the
command line, some change the appearance of the published result.</p>
<h2 id="tab-completion">Tab completion</h2>
<p><code>pbb</code> knows only a bunch of subcommands (five, to be
precise); now, when typing <code>pbb</code>, tab completion suggests
them. That is, if the completion file is in the right place, which a
(forthcoming) installation script has to take care of.</p>
<h2 id="language-setting">Language setting</h2>
<p>Pandoc’s default HTML has an empty <code>lang</code> property in the
opening <code>&lt;html&gt;</code> tag, which is <a
href="https://youtu.be/NP94u7y_KkQ">bad for screen readers</a>.
Previously, <code>pbb</code> would default to inserting
<code>en-CA</code>; now, it tries to infer the language from environment
variables. This is surprisingly non-straightforward; I settled on the
same priority order as <a
href="https://www.gnu.org/software/gettext/manual/html_node/Locale-Environment-Variables.html#Locale-Environment-Variables">gettext</a>,
which collapses to this beautiful declaration:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="va">lang</span><span class="op">=</span><span class="va">${LANGUAGE</span><span class="op">:-</span><span class="va">${LC_ALL</span><span class="op">:-</span><span class="va">${LC_MESSAGES</span><span class="op">:-</span><span class="va">$LANG}}}</span></span></code></pre></div>
<p>Some special characters have to be replaced to make for a valid
language tag; if none of these variables have a value, <code>pbb</code>
defaults to <code>en-US</code>. I guess eventually, there should be an
option to make the language a configuration value.</p>
<h2 id="local-server">Local server</h2>
<p>To look at the built site before deploying it, I used to use the
Python one-liner that spins up an HTTP server on localhost; for
convenience, this is now done by <code>pbb serve</code>, which just
calls</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> http.server <span class="at">--directory</span> artifacts</span></code></pre></div>
<p>under the hood.</p>
<h2 id="favicon">Favicon</h2>
<p><code>pbb build</code> now checks if there is an image with a name
that matches <code>favicon.*</code> in the <code>assets</code>
directory. If so, it gets converted to a 32x32 PNG file and included as
the favicon on each page.</p>
<p>The actual conversion is quite flexible: as long as ImageMagick can
handle the input format, the favicon gets created. The input file can
even be an animated GIF; in that case, the first frame is used. The
command is this one:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">convert</span> <span class="st">&quot;</span><span class="va">${infile</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="va">}</span><span class="st">[0]&quot;</span> <span class="at">-resize</span> 32x32^ <span class="at">-gravity</span> center <span class="dt">\</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">-background</span> none <span class="at">-extent</span> 32x32 artifacts/favicon.png</span></code></pre></div>
<p><code>infile</code> is an array of all files matching
<code>favicon.*</code>; at this point, there’s already been a test to
make sure that its length is 1.</p>
<p>The rest of the command takes care of all the details:</p>
<ul>
<li>Extract the first frame in case there are multiple with the
<code>[0]</code> index; this simply does nothing if there aren’t
multiple frames.</li>
<li>Resize to fill (and potentially overflow) 32x32 pixels, from the
centre of the input image with
<code>-resize 32x32^ -gravity center</code></li>
<li>Preserve transparent background for PNG inputs with
<code>-background none</code></li>
<li>Crop outside of the 32x32 square with
<code>-extent 32x32</code></li>
</ul>
<h2 id="web-fonts">Web fonts</h2>
<p>I wanted to have pretty fonts instead of the system defaults. A
convenient way for doing so is to include fonts via <a
href="https://developers.google.com/fonts">Google web fonts</a>. I want
<code>pbb</code> to be minimal and privacy respecting, and the pages
should load fast, so I wondered if I should host the fonts myself or
fetch them from Google.</p>
<p>Regarding the privacy aspect, Google <a
href="https://developers.google.com/fonts/faq#what_does_using_the_google_fonts_api_mean_for_the_privacy_of_my_users">says</a>
they only log aggregate data, and in a recent <a
href="https://news.ycombinator.com/item?id=22368247">discussion on
Hacker News</a>, a member of the original team that launched Google
Fonts <a href="https://news.ycombinator.com/item?id=22370250">says</a>
that there are lower hanging fruits than fonts if you really wanted to
track users. For whatever that’s worth, I guess.</p>
<p>Regarding performance, I found a <a
href="https://www.tunetheweb.com/blog/should-you-self-host-google-fonts">great
article</a> covering about everything I could have wondered. It’s not
actually that clear cut; for example: using Google instead of
self-hosting gets you updates to the fonts and lets you benefit from
technological improvements such as variable fonts once they become more
commonplace, without having to change anything at all. On the other
hand, Google can change your font and <a
href="https://github.com/google/fonts/issues/1137">break your page</a>
in the process.</p>
<p>Google is also smart in how it delivers the font: the CSS returned
contains a font format tailored to the user agent, and the fonts contain
hints or not based on the OS. Replicating this when self-hosting is not
trivial.</p>
<p>As a negative, because requesting CSS from a third party is involved,
rendering is blocked until all the CSS has been loaded. This was the
reason for a substantial performance improvement for the author of the
article and why he ended up self-hosting.</p>
<p>In the end, I decided to load the fonts from Google for now, as it
keeps my CSS a lot simpler. I optimized the requests as far as possible
with a <code>preconnect</code> resource hint, and I suspect for my tiny
page, the difference isn’t noticeable anyway. Later on, I may want to
self-host the fonts, though.</p>
<p>Until then, Google serves my fonts of choice, <a
href="https://fonts.adobe.com/fonts/source-sans">Source Sans Pro</a> for
text and <a href="https://fonts.adobe.com/fonts/source-code-pro">Source
Code Pro</a> for code.</p>
<script data-goatcounter="https://artifishellintelligence.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
